<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML>
<HEAD>
<TITLE>AUPG/rpacct.pl</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#1F00FF" ALINK="#FF0000" VLINK="#9900DD">
<A NAME="top"> </A>
<A NAME="file1"> </A>
<H1><a href="rpacct.pl">rpacct.pl</a></H1>

<PRE>
<I><FONT COLOR="#B22222">#!/usr/local/bin/perl
</FONT></I><I><FONT COLOR="#B22222"># -*- Mode:Perl; Coding:us-ascii-unix; fill-column:132 -*-
</FONT></I>
<I><FONT COLOR="#B22222">####################################################################################################################################
</FONT></I><I><FONT COLOR="#B22222"># @file      rpacct.pl
</FONT></I><I><FONT COLOR="#B22222"># @author    Mitch Richling &lt;http://www.mitchr.me/&gt;
</FONT></I><I><FONT COLOR="#B22222"># @Copyright Copyright 1998 by Mitch Richling.  All rights reserved.
</FONT></I><I><FONT COLOR="#B22222"># @brief     How to parse System V accounting files@EOL
</FONT></I><I><FONT COLOR="#B22222"># @Keywords
</FONT></I><I><FONT COLOR="#B22222"># @Std       Perl5
</FONT></I><I><FONT COLOR="#B22222">#
</FONT></I><I><FONT COLOR="#B22222"># This program is intended to read and parse a process accounting file generated by a SVR4 system like Solaris.
</FONT></I><I><FONT COLOR="#B22222">#
</FONT></I><I><FONT COLOR="#B22222"># The 'acct' struct contains:
</FONT></I><I><FONT COLOR="#B22222">#   char     ac_flag;     Accounting flag
</FONT></I><I><FONT COLOR="#B22222">#   char     ac_stat;     Exit status
</FONT></I><I><FONT COLOR="#B22222">#   uid32_t  ac_uid;      Accounting user ID
</FONT></I><I><FONT COLOR="#B22222">#   gid32_t  ac_gid;      Accounting group ID
</FONT></I><I><FONT COLOR="#B22222">#   dev32_t  ac_tty;      control typewriter
</FONT></I><I><FONT COLOR="#B22222">#   time32_t ac_btime;    Beginning time
</FONT></I><I><FONT COLOR="#B22222">#   comp_t   ac_utime;    acctng user time in clock ticks
</FONT></I><I><FONT COLOR="#B22222">#   comp_t   ac_stime;    acctng system time in clock ticks
</FONT></I><I><FONT COLOR="#B22222">#   comp_t   ac_etime;    acctng elapsed time in clock ticks
</FONT></I><I><FONT COLOR="#B22222">#   comp_t   ac_mem;      memory usage
</FONT></I><I><FONT COLOR="#B22222">#   comp_t   ac_io;       chars transferred
</FONT></I><I><FONT COLOR="#B22222">#   comp_t   ac_rw;       blocks read or written
</FONT></I><I><FONT COLOR="#B22222">#   char     ac_comm[8];  command name
</FONT></I><I><FONT COLOR="#B22222">#
</FONT></I><I><FONT COLOR="#B22222"># comp_t is a 16-bit fixed point number.  A 3-bit exponent in the high order bits, and a 13-bit fraction in the low order bits.
</FONT></I><I><FONT COLOR="#B22222"># uid32_t, gid32_t, time32_t are all 32-bit integers.  char is an 8-bit quantity.
</FONT></I><I><FONT COLOR="#B22222">#
</FONT></I><I><FONT COLOR="#B22222"># Decoding the comp_t type:
</FONT></I><I><FONT COLOR="#B22222">#
</FONT></I><I><FONT COLOR="#B22222"># This is a very compact expression for a floating point number. The floating point number hidden with a member $foo of comp_t type
</FONT></I><I><FONT COLOR="#B22222"># may be extracted with: ($foo &amp; 8191) * (8 ** ($foo &gt;&gt; 13))
</FONT></I><I><FONT COLOR="#B22222">#
</FONT></I><I><FONT COLOR="#B22222"># A process accounting file is a file full of 'acct' structs.  Thus we can read the data in blocks that are the size of an acct
</FONT></I><I><FONT COLOR="#B22222"># struct and then break the blocks up into the parts we are interested in.  From the sizes and types of the structure components we
</FONT></I><I><FONT COLOR="#B22222"># should be able to use a format string of ccLLLLSSSSSSA8 to unpack this data structure, but we have an alignment problem.  We have
</FONT></I><I><FONT COLOR="#B22222"># an extra two bytes stuck between the ac_stat member and the ac_uid member.  It is ironic that such a carefully constructed data
</FONT></I><I><FONT COLOR="#B22222"># structure designed to conserve space has a hole in it. :) The format string we must us is ccc2LLLLSSSSSSA8
</FONT></I><I><FONT COLOR="#B22222">#
</FONT></I><I><FONT COLOR="#B22222"># Meaning of the members:
</FONT></I><I><FONT COLOR="#B22222">#   - ac_utime, ac_stime, ac_etime are all in clock ticks.  For SPARC Solaris this is 100.
</FONT></I><I><FONT COLOR="#B22222">#   - ac_btime is the time the process started.  It is expressed as the standard UNIX time number stored in a 32-bit quantity.
</FONT></I><I><FONT COLOR="#B22222">#   - ac_mem is a strange one.  Each tick, the OS updates this value with (data_size + text_size) /
</FONT></I><I><FONT COLOR="#B22222">#     (number_of_in-core_processes_using_text) Thus ac_mem/(ac_stime+ac_utime) is a measure of the average memory used.  This is in
</FONT></I><I><FONT COLOR="#B22222">#     pages.  So you have to know the page size of the host the process accounting file came from.
</FONT></I><I><FONT COLOR="#B22222">#   - ac_flags is a flag quantity.  The bit at 01 means the thing forked but did not exec.  The bit at 02 means that the program ran
</FONT></I><I><FONT COLOR="#B22222">#     with UID 0 privileges.
</FONT></I>
<I><FONT COLOR="#B22222">##----------------------------------------------------------------------------------------------------------------------------------
</FONT></I>
$TICKSPERSEC = 100.0;
$PAGESIZE = 8.0;

<B><FONT COLOR="#A020F0">printf</FONT></B>(<B><FONT COLOR="#BC8F8F">&quot;%-10s %-10s %-10s %20s %20s %12s %12s %12s %10s %12s %15s %5s %5s\n&quot;</FONT></B>,
       <B><FONT COLOR="#BC8F8F">'Command'</FONT></B>, <B><FONT COLOR="#BC8F8F">'User'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Group'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Start_Time'</FONT></B>, <B><FONT COLOR="#BC8F8F">'End_Time'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Run_Sec'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Usr_CPU'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Sys_CPU'</FONT></B>, <B><FONT COLOR="#BC8F8F">'RAM'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Blk_I/O'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Char_I/O'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Exit'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Flags'</FONT></B>);
<B><FONT COLOR="#A020F0">printf</FONT></B>(<B><FONT COLOR="#BC8F8F">&quot;%-10s %-10s %-10s %20s %20s %12s %12s %12s %10s %12s %15s %5s %5s\n&quot;</FONT></B>,
       <B><FONT COLOR="#BC8F8F">''</FONT></B>, <B><FONT COLOR="#BC8F8F">''</FONT></B>, <B><FONT COLOR="#BC8F8F">''</FONT></B>, <B><FONT COLOR="#BC8F8F">'Local'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Local'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Sec'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Sec'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Sec'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Kbytes'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Blocks'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Bytes'</FONT></B>, <B><FONT COLOR="#BC8F8F">'Dec'</FONT></B>, <B><FONT COLOR="#BC8F8F">''</FONT></B>);
<B><FONT COLOR="#A020F0">open</FONT></B>(FP, <B><FONT COLOR="#BC8F8F">&quot;&lt;$ARGV[0]&quot;</FONT></B>) || <B><FONT COLOR="#A020F0">die</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;ugh\n&quot;</FONT></B>;
<B><FONT COLOR="#A020F0">while</FONT></B>($numRead = <B><FONT COLOR="#A020F0">read</FONT></B>(FP,$data,40)) {
  <B><FONT COLOR="#A020F0">if</FONT></B>($numRead = 40) {
    <I><FONT COLOR="#B22222"># Unpack the structure into variables.
</FONT></I>    ($ac_flag, $ac_stat, $junk, $junk, $ac_uid, $ac_gid, $ac_tty, $ac_btime, $ac_utime, 
     $ac_stime, $ac_etime, $ac_mem, $ac_io, $ac_rw, $ac_comm) = <B><FONT COLOR="#A020F0">unpack</FONT></B>(<B><FONT COLOR="#BC8F8F">&quot;ccc2LLLLSSSSSSA8&quot;</FONT></B>, $data);
    <I><FONT COLOR="#B22222"># Get uname
</FONT></I>    $ac_uname = <B><FONT COLOR="#A020F0">getpwuid</FONT></B>($ac_uid);
    <I><FONT COLOR="#B22222">#Get group name
</FONT></I>    $ac_grp = <B><FONT COLOR="#A020F0">getgrgid</FONT></B>($ac_gid);
    <I><FONT COLOR="#B22222"># Get start date
</FONT></I>    ($st_sec, $st_min, $st_hour, $st_mday, $st_mon, $st_year, $st_wday, $st_yday, $st_isdst) = <B><FONT COLOR="#A020F0">localtime</FONT></B>($ac_btime);
    $st_date = <B><FONT COLOR="#A020F0">sprintf</FONT></B>(<B><FONT COLOR="#BC8F8F">&quot;%4d-%02d-%02d_%02d:%02d:%02d&quot;</FONT></B>, $st_year+1900, $st_mon+1, $st_mday, $st_hour, $st_min, $st_sec);
    <I><FONT COLOR="#B22222">#Get real time
</FONT></I>    $etime_real = ($ac_etime &amp; 8191) * (8 ** ($ac_etime &gt;&gt; 13)) / $TICKSPERSEC;
    <I><FONT COLOR="#B22222">#get end date
</FONT></I>    ($en_sec, $en_min, $en_hour, $en_mday, $en_mon, $en_year, $en_wday, $en_yday, $en_isdst) = <B><FONT COLOR="#A020F0">localtime</FONT></B>($ac_btime+$etime_real);
    $en_date = <B><FONT COLOR="#A020F0">sprintf</FONT></B>(<B><FONT COLOR="#BC8F8F">&quot;%4d-%02d-%02d_%02d:%02d:%02d&quot;</FONT></B>, $en_year+1900, $en_mon+1, $en_mday, $en_hour, $en_min, $en_sec);
    <I><FONT COLOR="#B22222">#get block io
</FONT></I>    $bio = ($ac_rw &amp; 8191) * (8 ** ($ac_rw &gt;&gt; 13));
    <I><FONT COLOR="#B22222">#get chr io
</FONT></I>    $cio = ($ac_io &amp; 8191) * (8 ** ($ac_io &gt;&gt; 13));
    <I><FONT COLOR="#B22222">#Get User CPU time
</FONT></I>    $ucpu_tim = ($ac_utime &amp; 8191) * (8 ** ($ac_utime &gt;&gt; 13)) / $TICKSPERSEC;
    <I><FONT COLOR="#B22222">#Get System CPU time
</FONT></I>    $scpu_tim = ($ac_stime &amp; 8191) * (8 ** ($ac_stime &gt;&gt; 13)) / $TICKSPERSEC;
    <I><FONT COLOR="#B22222">#Get RAM
</FONT></I>    $ram = ($ac_mem &amp; 8191) * (8 ** ($ac_mem &gt;&gt; 13));
    <I><FONT COLOR="#B22222">#Compute mean RAM use
</FONT></I>    <B><FONT COLOR="#A020F0">if</FONT></B>(($ac_stime+$ac_utime) &gt; 0)
      { $ram = $ram / ($ac_stime+$ac_utime); }
    $ram = $ram * $PAGESIZE;
    $flags = ($ac_flag &amp; 01?<B><FONT COLOR="#BC8F8F">&quot;F&quot;</FONT></B>:<B><FONT COLOR="#BC8F8F">&quot;_&quot;</FONT></B>) . ($ac_flag &amp; 02?<B><FONT COLOR="#BC8F8F">&quot;R&quot;</FONT></B>:<B><FONT COLOR="#BC8F8F">&quot;_&quot;</FONT></B>);

    <I><FONT COLOR="#B22222">#Print the record data out.
</FONT></I>    <B><FONT COLOR="#A020F0">printf</FONT></B>(<B><FONT COLOR="#BC8F8F">&quot;%-10s %-10s %-10s %20s %20s %12.2f %12.2f %12.2f %10d %12.2f %15.1f %5d %5s\n&quot;</FONT></B>,
           $ac_comm, $ac_uname, $ac_grp, $st_date, $en_date, $etime_real, $ucpu_tim, $scpu_tim, $ram, $bio, $cio, <B><FONT COLOR="#A020F0">int</FONT></B>($ac_stat), $flags);
  }
}
<B><FONT COLOR="#A020F0">close</FONT></B>(FP);
</PRE>
<HR \/>
<ADDRESS>Generated by <A HREF="http://www.iki.fi/~mtr/genscript/">GNU Enscript 1.6.5.90</A>.</ADDRESS>
</BODY>
</HTML>
